name: Update Slack SDK

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: "0 9 * * *"
  workflow_dispatch: # Allow manual triggering

concurrency:
  group: update-slack-sdk
  cancel-in-progress: false

jobs:
  check-and-update:
    name: Check for Slack SDK Updates
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Check for updates
        id: check
        run: |
          CURRENT_VERSION=$(jq -r '.slackWebApiVersion' src/generated/_metadata.json)
          CURRENT_METHOD_COUNT=$(jq -r '.methodCount' src/generated/_metadata.json)
          LATEST_VERSION=$(npm view @slack/web-api version)

          # Validate current version from _metadata.json
          if ! [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid current version format in _metadata.json: $CURRENT_VERSION"
            exit 1
          fi

          # Validate latest version matches stable semver pattern (no pre-release)
          if ! [[ "$LATEST_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid version format from npm: $LATEST_VERSION"
            exit 1
          fi

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "current_method_count=$CURRENT_METHOD_COUNT" >> $GITHUB_OUTPUT

          # Determine which version is newer using semantic version comparison
          NEWER_VERSION=$(printf '%s\n%s\n' "$CURRENT_VERSION" "$LATEST_VERSION" | sort -V | tail -n1)

          if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "✓ Already up to date: $CURRENT_VERSION"
          elif [ "$NEWER_VERSION" = "$LATEST_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "⬆ Update available: $CURRENT_VERSION → $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "ℹ Skipping: npm returned older version $LATEST_VERSION (current: $CURRENT_VERSION)"
          fi

      - name: Check for existing PR
        if: steps.check.outputs.needs_update == 'true'
        id: existing-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="chore/update-slack-web-api-${{ steps.check.outputs.latest_version }}"
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING_PR already exists for this update"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update dependency
        if: steps.check.outputs.needs_update == 'true' && steps.existing-pr.outputs.exists == 'false'
        run: bun add "@slack/web-api@${{ steps.check.outputs.latest_version }}"

      - name: Regenerate services
        if: steps.check.outputs.needs_update == 'true' && steps.existing-pr.outputs.exists == 'false'
        id: generate
        run: |
          bun run generate

          NEW_METHOD_COUNT=$(jq -r '.methodCount' src/generated/_metadata.json)
          echo "new_method_count=$NEW_METHOD_COUNT" >> $GITHUB_OUTPUT

          # Validate NEW_METHOD_COUNT is a valid integer
          if ! [[ "$NEW_METHOD_COUNT" =~ ^[0-9]+$ ]]; then
            echo "Error: new_method_count ('$NEW_METHOD_COUNT') is not a valid integer" >&2
            exit 1
          fi

          OLD_COUNT="${{ steps.check.outputs.current_method_count }}"
          if [ -z "$OLD_COUNT" ]; then
            echo "Error: current_method_count is not set" >&2
            exit 1
          fi
          if ! [[ "$OLD_COUNT" =~ ^[0-9]+$ ]]; then
            echo "Error: current_method_count ('$OLD_COUNT') is not a valid integer" >&2
            exit 1
          fi

          DIFF=$((NEW_METHOD_COUNT - OLD_COUNT))

          if [ $DIFF -gt 0 ]; then
            echo "method_diff=+$DIFF" >> $GITHUB_OUTPUT
          elif [ $DIFF -lt 0 ]; then
            echo "method_diff=$DIFF" >> $GITHUB_OUTPUT
          else
            echo "method_diff=0" >> $GITHUB_OUTPUT
          fi

      - name: Run CI checks
        if: steps.check.outputs.needs_update == 'true' && steps.existing-pr.outputs.exists == 'false'
        run: |
          bun run lint
          bun run format:check
          bun run typecheck
          bun run test
          bun run build

      - name: Create changeset
        if: steps.check.outputs.needs_update == 'true' && steps.existing-pr.outputs.exists == 'false'
        run: |
          CURRENT_VERSION="${{ steps.check.outputs.current_version }}"
          LATEST_VERSION="${{ steps.check.outputs.latest_version }}"

          # Parse semver components
          CURRENT_MAJOR="${CURRENT_VERSION%%.*}"
          CURRENT_REST="${CURRENT_VERSION#*.}"
          CURRENT_MINOR="${CURRENT_REST%%.*}"

          LATEST_MAJOR="${LATEST_VERSION%%.*}"
          LATEST_REST="${LATEST_VERSION#*.}"
          LATEST_MINOR="${LATEST_REST%%.*}"

          # Determine bump type based on semver diff
          if [ "$LATEST_MAJOR" -gt "$CURRENT_MAJOR" ]; then
            BUMP_TYPE="major"
          elif [ "$LATEST_MAJOR" -eq "$CURRENT_MAJOR" ] && [ "$LATEST_MINOR" -gt "$CURRENT_MINOR" ]; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi

          CHANGESET_ID=$(echo "$LATEST_VERSION" | tr '.' '-')
          CHANGESET_FILE=".changeset/update-slack-sdk-${CHANGESET_ID}.md"

          if [ -f "$CHANGESET_FILE" ]; then
            echo "Changeset file '$CHANGESET_FILE' already exists, skipping creation."
          else
            {
              echo '---'
              echo "\"effect-slack\": $BUMP_TYPE"
              echo '---'
              echo ''
              echo "Update @slack/web-api from $CURRENT_VERSION to $LATEST_VERSION"
            } > "$CHANGESET_FILE"
          fi

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true' && steps.existing-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="chore/update-slack-web-api-${{ steps.check.outputs.latest_version }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$BRANCH_NAME"
          git add package.json bun.lock src/generated .changeset
          git commit -m "chore: update @slack/web-api to ${{ steps.check.outputs.latest_version }}"
          git push -u origin "$BRANCH_NAME"

          METHOD_DIFF="${{ steps.generate.outputs.method_diff }}"
          if [ "$METHOD_DIFF" = "0" ]; then
            METHOD_INFO="Method count unchanged (${{ steps.generate.outputs.new_method_count }} methods)"
          else
            METHOD_INFO="Method count: ${{ steps.check.outputs.current_method_count }} → ${{ steps.generate.outputs.new_method_count }} ($METHOD_DIFF)"
          fi

          {
            echo '## Summary'
            echo ''
            echo 'Automated update of `@slack/web-api` dependency.'
            echo ''
            echo '- **Version**: ${{ steps.check.outputs.current_version }} → ${{ steps.check.outputs.latest_version }}'
            echo "- $METHOD_INFO"
            echo ''
            echo '## Changes'
            echo ''
            echo '- Updated `@slack/web-api` dependency'
            echo '- Regenerated Effect service wrappers'
            echo '- Created changeset for versioning'
            echo ''
            echo '## Verification'
            echo ''
            echo 'All CI checks passed:'
            echo '- [x] Lint'
            echo '- [x] Format'
            echo '- [x] Typecheck'
            echo '- [x] Tests'
            echo '- [x] Build'
            echo ''
            echo 'See [Slack Web API releases](https://github.com/slackapi/node-slack-sdk/releases) for changelog.'
            echo ''
            echo 'Release notes: https://github.com/slackapi/node-slack-sdk/releases/tag/@slack/web-api@${{ steps.check.outputs.latest_version }}'
            echo ''
            echo '---'
            echo '*Automated by Update Slack SDK workflow*'
          } > /tmp/pr-body.md

          gh pr create \
            --base main \
            --title "chore: update @slack/web-api to ${{ steps.check.outputs.latest_version }}" \
            --body-file /tmp/pr-body.md
